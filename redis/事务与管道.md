# 事务

## 是什么

本质是一组命令的集合。一个事务中的所有命令都会序列化，按顺序地串行化执行，**而不会被其他命令插入、不允许加塞**



## Redis事务vs数据库事务

有几点区别：

1.不保证原子性。不保证所有命令执行时同时成功或失败，也不提供回滚能力。

2.排他性。redis一个事务内的命令会依次执行，不会被其他事务插入。

3.没有隔离级别的概念。redis的事务提交前，任何命令都不会被执行。所以不存在”事务内的查询要看到事务里的更新，在事务外查询不能看到”这种问题了

4.单独的隔离操作。redis的事务仅仅是保证事务里的操作会被连续独占的执行，redis命令执行是单线程架构，在执行完事务内所有指令前是不可能再去同时执行其他客户端的请求的

## 常用命令

`multi`：开启一个事务

`exec`：执行所有事务内的命令

`discard`：取消事务，放弃执行事务块内所有的名利

`watch `：监听一个或多个key，如果在事务执行前被其他命令改动，事务会被打断

`unwatch`：放弃监听



## 执行方式

1. 全部执行
2. 最终放弃
3. 全体连坐：执行前，发现有命令语法错误。
4. 冤有头，债有主。执行时，发现有命令错误，则只有该命令放弃执行，其他命令照常执行。
5. 监听！！redis使用乐观锁定，当锁定对象发生改变时，事务放弃执行。



# 管道

## 是什么

大数量数据操作时，为了减少redis客户端与服务端命令往返延迟，将命令统一打包一次性发送，对整个redis的执行不造成其他影响。

批处理命令变种优化措施

## 区别

### pipeline和原生批量命令对比

- 原生批量命令是原子性的，而pipeline是非原子性的
- 原生批量命令一次只能执行一种命令，pipeline支持批量执行不同命令
- 原生批量命令是服务端实现，而pipeline需要服务端与客户端共同实现
- 

### pipeline与事务

- 管道是一次性将多个命令发送到服务器，事务是一条一条发
- 事务只有在接受到exec命令后才会执行，管道不会
- 执行事务时会阻塞其他命令执行，而执行管道中的命令不会

## 注意事项

pipeline缓冲指令只会依次执行，不保证原子性。

使用pipeline组装的命令个数不能太多，不如会导致数据量过大客户端阻塞时间过久，同时服务器也会被迫回复一个队列，占用很多内存。